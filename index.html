<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Airdrop Farming Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- tiny inline favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%23fff'/%3E%3Ctext x='32' y='39' font-size='28' text-anchor='middle' fill='%23000'%3E‚úì%3C/text%3E%3C/svg%3E">
  <style>
    :root{
      --bg:#0b0d10; --panel:#0f1115; --panel-2:#111827; --text:#e5e7eb;
      --muted:#9ca3af; --border:#1f2937; --link:#93c5fd; --link-hover:#bfdbfe;
    }
    html,body{height:100%} body{background:var(--bg);color:var(--text)}
    a{color:var(--link)} a:hover{color:var(--link-hover)}
    .sticky-top-bg{background:var(--panel);box-shadow:0 2px 16px rgba(0,0,0,.6);border:1px solid var(--border)}
    .subhead{color:var(--muted)}

    /* Table */
    .table{
      --bs-table-bg:var(--panel);--bs-table-color:var(--text);
      --bs-table-striped-bg:var(--panel-2);--bs-table-striped-color:var(--text);
      --bs-table-border-color:var(--border);
    }
    .table thead th{background:var(--panel-2);border-color:var(--border);text-align:center;vertical-align:middle}
    .project-cell a{text-decoration:underline}
    .project-col{min-width:220px}
    .desc-col{color:var(--muted);font-size:.9rem;white-space:normal;vertical-align:middle !important}
    .routine-col{font-size:.9rem;vertical-align:middle !important}
    .routine-col ul{margin-bottom:0;padding-left:1.2rem}
    .routine-col li{margin-bottom:.15rem}
    .today-col{width:72px;text-align:center}
    .history-col{width:40px;text-align:center}
    .score-col{min-width:200px; vertical-align:middle !important}
    .table-responsive{overflow-x:auto}

    .status-box{width:26px;height:26px;border-radius:4px;border:1px solid rgba(255,255,255,.06);display:inline-block}
    .status-green{background:#21c35e} .status-yellow{background:#f1c40f} .status-red{background:#e74c3c}
    .legend .status-box{width:18px;height:18px;vertical-align:text-bottom}

    .note-badge{font-size:.70rem}
    .form-check-input[readonly]{pointer-events:none}
    .code-badge{cursor:pointer}
    .controls .btn{margin-right:.5rem}

    /* Banner: ‚âà2/3 largeur desktop, full sur mobile */
    .banner-wrap{
      margin:12px auto 6px;border-radius:12px;overflow:hidden;border:1px solid var(--border);background:#000;
      width:66vw;max-width:1400px;
    }
    .banner-wrap img{width:100%;height:auto;display:block}
    .banner-meta{width:66vw;max-width:1400px;margin:6px auto 12px;text-align:center;color:var(--muted);font-size:.95rem}
    @media (max-width:991.98px){.banner-wrap{width:100%}.banner-meta{width:100%}}
  </style>
</head>
<body>
  <div class="container-fluid py-3">

    <!-- Banner -->
    <div class="banner-wrap">
      <img src="banner.png" alt="Banner" onerror="this.closest('.banner-wrap').remove();document.querySelector('.banner-meta')?.remove();">
    </div>
    <div class="banner-meta">
      Made with Love and Motivation by
      <a href="https://x.com/PetrAnto12" target="_blank" rel="noopener">@PetrAnto12</a>
    </div>

    <div class="d-flex align-items-center justify-content-between mb-3 sticky-top sticky-top-bg px-2 py-2 rounded-3">
      <div>
        <h1 class="h4 mb-0">Airdrop Farming Tracker</h1>
        <div class="subhead">Mode sombre ‚Ä¢ Auto-tick au clic ‚Ä¢ Confirmation manuelle ‚Ä¢ Local + Cloud (Supabase)</div>
      </div>
      <div class="controls">
        <button id="resetTodayBtn" class="btn btn-outline-secondary btn-sm">Reset today</button>
        <button id="resetAllBtn" class="btn btn-outline-danger btn-sm">Reset all</button>

        <button id="exportBtn" class="btn btn-outline-primary btn-sm">Export</button>
        <label class="btn btn-outline-primary btn-sm mb-0">
          Import <input id="importInput" type="file" accept="application/json" hidden>
        </label>

        <button id="sbAccountBtn" class="btn btn-success btn-sm">Account (Email)</button>
      </div>
    </div>

    <!-- Upsell Routine Score -->
    <div id="proNote" class="alert alert-dark border-secondary py-2 small d-none" role="alert">
      <strong>Routine Score</strong> est une fonctionnalit√© <span class="badge text-bg-warning">Pro</span>. Connectez-vous par email pour sauvegarder/charger vos donn√©es. Si vous √™tes abonn√©, la colonne appara√Æt automatiquement.
    </div>

    <div class="table-responsive">
      <table id="trackerTable" class="table table-bordered table-striped align-middle">
        <thead id="trackerHead"></thead>
        <tbody id="trackerBody"></tbody>
      </table>
    </div>

    <div class="legend mt-3">
      <span class="me-3"><span class="status-box status-red me-1"></span> No click and no farm</span>
      <span class="me-3"><span class="status-box status-yellow me-1"></span> Click but no farm confirmed</span>
      <span class="me-3"><span class="status-box status-green me-1"></span> Click and farm OK</span>
    </div>

    <div class="mt-4" style="color:var(--muted);font-size:.9rem">
      <strong>Notes :</strong> ‚ÄúClick‚Äù s‚Äôauto-coche quand vous ouvrez le lien ; ‚ÄúFarm‚Äù est manuel.
      Les fen√™tres Semaine/Mois/Trimestre sont calcul√©es √† partir du journal quotidien. Cloud via Supabase (magic link).
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
    <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Done</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Supabase Modal -->
  <div class="modal fade" id="sbModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border border-secondary">
        <div class="modal-header">
          <h5 class="modal-title">Cloud Sync (Email)</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="sbAuthArea">
            <label class="form-label">Email pour magic link</label>
            <input id="sbEmail" type="email" class="form-control form-control-sm" placeholder="you@domain.com">
            <button id="sbSendLink" class="btn btn-primary btn-sm mt-2">Envoyer le magic link</button>
            <div class="small text-secondary mt-2">Vous recevrez un lien √† usage unique.</div>
          </div>
          <div id="sbUserArea" class="d-none">
            <div class="mb-2">Connect√© en tant que <span id="sbUserEmail"></span>
              <span id="sbSubBadge" class="badge ms-2"></span>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <button id="sbSave" class="btn btn-primary btn-sm">Save to Cloud</button>
              <button id="sbLoad" class="btn btn-outline-primary btn-sm">Load from Cloud</button>
              <button id="sbSignOut" class="btn btn-outline-danger btn-sm ms-auto">Sign out</button>
            </div>
            <div id="sbStatus" class="small text-secondary mt-2"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- App -->
  <script>
    // ====== SUPABASE CONFIG (tes valeurs) ======
    const SUPABASE_URL = 'https://naksqjsuivlalltonldj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ha3NxanN1aXZsYWxsdG9ubGRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MjgxNzYsImV4cCI6MjA3MjQwNDE3Nn0.8LttdRBSqP-zYPeUJpMGNIVly7h5mJ6MoZfP3i1-EOs';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== FLAGS AUTH/PRO ======
    let IS_AUTH = false;
    let IS_SUBSCRIBER = false; // Affiche la colonne "Routine Score" si true
    let REGISTERED_AT = null;  // Date d'inscription (profiles.registered_at)

    // ====== DONN√âES SITES ======
    const PROJECTS = [
      { key:'fantasyTop',  name:'FantasyTop',  url:'https://fantasy.top?ref=petranto12', desc:'Fantasy trading of creators',
        routine:['Daily: claim/check-in & scan missions','Trade: buy/sell 1 card OR set/refresh a lineup','Engage: follow/like 3 creator profiles','Verify: claim rewards / update streak']},
      { key:'cookieFun',   name:'Cookie.fun',  url:'https://www.cookie.fun/profile', desc:'Quests & mini-games',
        routine:['Open profile ‚Üí check daily tasks','Play 1 mini-game/spin; finish 1‚Äì2 quests','Claim daily/streak rewards','Review: new events or multipliers']},
      { key:'kaito',       name:'Kaito (Yaps)', url:'https://yaps.kaito.ai/referral/1382662710396080133', desc:'AI/social research app',
        routine:['Post 1 yap OR reply with value','Engage: like/repost 3 items','Check quests/XP tab; complete 1 task','Review alerts/topics for fresh signals']},
      { key:'galxe',       name:'Galxe', url:'https://app.galxe.com/hub/invite?code=GICyJr43Nj1NJrZqi4fhOdcjt4V_avTgEEJxuu-AC0=', desc:'Quest & airdrop hub',
        routine:['Open campaigns; pick 1‚Äì2 quick quests','Complete on-chain/off-chain steps & verify','Claim OAT/points if eligible','Track: new partner campaigns']},
      { key:'klout',       name:'Klout.gg', url:'https://klout.gg/', desc:'Social points tracker', referralNote:'Referral: ‚Äúpetranto üß¨‚Äù', copyText:'petranto üß¨',
        routine:['Market: Open/Close Long/Short positions','Klout: Post Quality Content','Shout: Share referral','Chaser: Play and win at least once']},
      { key:'wallchain',   name:'Wallchain (Quacks)', url:'https://quacks.app/?ref=PetrAnto12', desc:'Referral/points portal',
        routine:['Dashboard: daily open & check-in','Complete 1 boost/quest (follow/like/etc.)','Share referral once where relevant','Verify completion; monitor points']},
      { key:'ethos',       name:'Ethos', url:'https://app.ethos.network/', desc:'Web3 profile & quests',
        routine:['Quests: complete 1 task','Sync: connect wallet / verify socials','Profile: update bio/links if needed','Claim any available rewards']},
      { key:'fundamental', name:'Fundamental.lol', url:'https://fundamental.lol/r/?node=PetrAnto12-5mu', desc:'Onchain social hub',
        routine:['Daily visit & check-in','Engage with 3 feeds or posts','Complete 1 mission; submit proof if asked','Track node/referral stats']},
      { key:'addicted',    name:'Addicted.fun', url:'https://addicted.fun', desc:'Daily tasks & games', referralNote:'Invite code', copyText:'IHMJC4DK',
        routine:['Open ‚ÄúDaily‚Äù and quick tasks','Finish 1‚Äì3 quests or a mini-game','Claim streak & any bonus chests','Peek at limited-time events']},
      { key:'addplus',     name:'AddPlus.org', url:'https://addplus.org/boost/PetrAnto12', desc:'Engagement boosters',
        routine:['Run 1 boost from queue','Engage exactly as required (like/comment/etc.)','Verify completion and points','Check credits/balance & refill if needed']},
      { key:'mindoshare',  name:'Mindoshare.ai', url:'https://mindoshare.ai/kol?ref=cmev63nqn01mllr3wtpn2whcm', desc:'KOL tasks & referrals',
        routine:['Pick 1 KOL task with good ROI','Execute steps; capture proof link/screenshot','Submit proof; confirm status','Monitor referrals/leaderboard']},
      { key:'xeetBoost',   name:'Xeet Boost', url:'https://www.xeet.ai/boost/PetrAnto12', desc:'Boost tasks (Xeet)',
        routine:['Complete 1‚Äì2 boosts','Verify in-app; ensure credit applied','Optional: publish 1 booster tweet','Check cooldowns / new boosts']},
      { key:'bantr',       name:'Bantr', url:'https://beta.bantr.fun?ic=1UB6N36', desc:'Engagement quests',
        routine:['Open daily quests','Vote or comment 3√ó on trending items','Submit any picks/predictions','Claim points; review upcoming rounds']},
      { key:'consumerfi',  name:'ConsumerFi', url:'https://www.consumerfi.ai/app?referral_code=PVZcXvqV', desc:'ConsumerFi quests',
        routine:['Daily check-in','Complete 1 survey/quiz','Invite/referral: share once','Verify rewards / payout queue']},
      { key:'astranovaBP', name:'Astranova BlackPass', url:'https://blackpass.astranova.world?referral_code=6ed940ede64b', desc:'NFT pass portal',
        routine:['Visit pass dashboard','Do 1 mission/mint if live','Track pass/points progress','Claim any available rewards']},
      { key:'kudoswap',    name:'KudoSwap', url:'https://kudoswap.com/PetrAnto12', desc:'Swap & quests',
        routine:['Swap a small amount (keep costs low)','Add/remove tiny LP once','Open quests tab; complete 1 action','Claim points / check streak']},
    ];

    // ====== P√âRIODES ======
    const PAST_DAYS = 7, PAST_WEEKS = 4, PAST_MONTHS = 3, PAST_QUARTERS = 3;

    // ====== UTILITAIRES ======
    const pad = n => String(n).padStart(2,'0');
    const today = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
    const addDays = (d,delta)=>{const nd=new Date(d); nd.setDate(nd.getDate()+delta); return nd;};
    const fmtDayCol = (d)=>{const m=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return `${pad(d.getDate())}-${m[d.getMonth()]}`;};
    const getISOWeek=(d)=>{const date=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));const dayNum=date.getUTCDay()||7;date.setUTCDate(date.getUTCDate()+4-dayNum);const ys=new Date(Date.UTC(date.getUTCFullYear(),0,1));return Math.ceil((((date-ys)/86400000)+1)/7);};
    const quarterOf=(d)=>Math.floor(d.getMonth()/3)+1;
    const toDateOnly = (x)=> new Date(new Date(x).getFullYear(), new Date(x).getMonth(), new Date(x).getDate());
    const dayDiff = (a,b)=> Math.floor((toDateOnly(b) - toDateOnly(a)) / 86400000);

    const lastNDays=(n)=>Array.from({length:n},(_,i)=>addDays(new Date(),-(i+1))).reverse();
    const lastNWeeks=(n)=>{const r=[];const now=new Date();for(let i=1;i<=n;i++){const end=addDays(now,-7*(i-1)),start=addDays(now,-7*i);r.unshift({start,end});}return r;};
    const lastNMonths=(n)=>{const r=[];const now=new Date();for(let i=1;i<=n;i++){const ref=new Date(now.getFullYear(),now.getMonth()-i,1);const start=new Date(ref.getFullYear(),ref.getMonth(),1);const end=new Date(ref.getFullYear(),ref.getMonth()+1,1);r.unshift({start,end,label:start.toLocaleString('en',{month:'long'})});}return r;};
    const lastNQuarters=(n)=>{const r=[];const now=new Date();let q=quarterOf(now)-1,y=now.getFullYear();for(let i=0;i<n;i++){if(q===0){q=4;y-=1;}const sm=(q-1)*3;const start=new Date(y,sm,1);const end=new Date(y,sm+3,1);r.unshift({start,end,label:`Q${q}-${String(y).slice(-2)}`});q-=1;}return r;};

    // ====== LOCAL STORAGE ======
    const STORAGE_KEY = 'airdropTracker.v2';
    const load = ()=>{try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||{}}catch{return {}}};
    const save = (data)=>localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    const ensureProj=(data,key)=>{if(!data[key]) data[key]={daily:{}}; return data[key];};

    const setTodayState=(key,patch)=>{const data=load();const proj=ensureProj(data,key);const t=today(); if(!proj.daily[t]) proj.daily[t]={clicked:false,farmed:false}; Object.assign(proj.daily[t],patch); save(data);};
    const getDayState=(key,dateStr)=>{const data=load();return (data[key]&&data[key].daily&&data[key].daily[dateStr])||{clicked:false,farmed:false}};
    const stateToColor=(s)=>(s.farmed&&s.clicked)?'green':(s.clicked?'yellow':'red');
    const aggregateRange=(key,start,end)=>{const d=new Date(start);let anyC=false,anyF=false;while(d<end){const ds=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;const s=getDayState(key,ds);anyC ||= s.clicked; anyF ||= (s.clicked && s.farmed); d.setDate(d.getDate()+1);} if(anyF) return 'green'; if(anyC) return 'yellow'; return 'red';};

    // ====== ROUTINE SCORE (Pro) ======
    function completionStatsForProject(key) {
      const reg = REGISTERED_AT ? toDateOnly(REGISTERED_AT) : toDateOnly(new Date());
      const tdy = toDateOnly(new Date());
      const totalDays = Math.max(1, dayDiff(reg, tdy) + 1);
      const data = load();
      const daily = (data[key] && data[key].daily) || {};
      let completed = 0;
      for (const ds of Object.keys(daily)) {
        const d = new Date(ds);
        if (toDateOnly(d) >= reg && toDateOnly(d) <= tdy) {
          if (daily[ds]?.farmed) completed++;
        }
      }
      const pct = Math.round(100 * (completed / totalDays));
      return { pct, completed, totalDays, since: `${reg.getFullYear()}-${pad(reg.getMonth()+1)}-${pad(reg.getDate())}` };
    }

    // ====== RENDU TABLE ======
    const headEl=document.getElementById('trackerHead');
    const bodyEl=document.getElementById('trackerBody');

    function renderHead(){
      headEl.innerHTML='';
      const days=lastNDays(PAST_DAYS), weeks=lastNWeeks(PAST_WEEKS), months=lastNMonths(PAST_MONTHS), quarters=lastNQuarters(PAST_QUARTERS);

      const tr1=document.createElement('tr');
      tr1.innerHTML = `
        <th rowspan="2" class="project-col text-center"></th>
        <th rowspan="2" class="desc-col text-center">Description</th>
        <th rowspan="2" class="routine-col text-center">Routine</th>
        ${IS_SUBSCRIBER ? `<th rowspan="2" class="score-col text-center">Routine Score <span class="badge text-bg-warning">Pro</span></th>` : ``}
        <th colspan="2" class="text-center">Today</th>
        <th colspan="${days.length}" class="text-center">Past 7 days</th>
        <th colspan="${weeks.length}" class="text-center">Past weeks</th>
        <th colspan="${months.length}" class="text-center">Past Months</th>
        <th colspan="${quarters.length}" class="text-center">Past Quarters</th>`;
      const tr2=document.createElement('tr');
      tr2.innerHTML = `
        <th class="today-col">Click</th>
        <th class="today-col">Farm</th>
        ${days.map(d=>`<th class="history-col">${fmtDayCol(d)}</th>`).join('')}
        ${weeks.map(w=>`<th class="history-col">CW${getISOWeek(addDays(w.end,-1))}</th>`).join('')}
        ${months.map(m=>`<th class="history-col">${m.label}</th>`).join('')}
        ${quarters.map(q=>`<th class="history-col">${q.label}</th>`).join('')}`;
      headEl.appendChild(tr1); headEl.appendChild(tr2);

      const proNote = document.getElementById('proNote');
      if (!IS_SUBSCRIBER) proNote.classList.remove('d-none'); else proNote.classList.add('d-none');
    }

    const escapeHtml=(s='')=>s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const renderRoutine=(arr)=>{ if(!arr||!arr.length) return ''; const items=arr.slice(0,4).map(x=>`<li>${escapeHtml(x)}</li>`).join(''); return `<ul class="mb-0">${items}</ul>`; };

    const makeStatusCell=(color)=>{const td=document.createElement('td'); td.className='text-center'; const div=document.createElement('div'); div.className=`status-box status-${color}`; td.appendChild(div); return td;};
    const setCellColor=(td,color)=>{const box=td.querySelector('.status-box'); if(!box) return; box.classList.remove('status-green','status-yellow','status-red'); box.classList.add(`status-${color}`);};

    function updateHistoryCellsForRow(key,tr){
      const days=lastNDays(PAST_DAYS), weeks=lastNWeeks(PAST_WEEKS), months=lastNMonths(PAST_MONTHS), quarters=lastNQuarters(PAST_QUARTERS);
      const preHistoryCols = 3 + (IS_SUBSCRIBER ? 1 : 0) + 2; // project, desc, routine, (score?), click, farm
      let colIndex = preHistoryCols;
      days.forEach(d=>{const ds=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; setCellColor(tr.cells[colIndex++], stateToColor(getDayState(key,ds)));});
      weeks.forEach(w=>setCellColor(tr.cells[colIndex++], aggregateRange(key,w.start,w.end)));
      months.forEach(m=>setCellColor(tr.cells[colIndex++], aggregateRange(key,m.start,m.end)));
      quarters.forEach(q=>setCellColor(tr.cells[colIndex++], aggregateRange(key,q.start,q.end)));
    }

    function renderBody(){
      bodyEl.innerHTML='';
      const days=lastNDays(PAST_DAYS), weeks=lastNWeeks(PAST_WEEKS), months=lastNMonths(PAST_MONTHS), quarters=lastNQuarters(PAST_QUARTERS);

      PROJECTS.forEach(p=>{
        const tr=document.createElement('tr');

        // Project
        const projectCell=document.createElement('td'); projectCell.className='project-cell';
        const a=document.createElement('a'); a.href=p.url; a.textContent=p.name; a.target='_blank'; a.rel='noopener';
        a.addEventListener('click',()=>{ setTodayState(p.key,{clicked:true}); const cb=document.querySelector(`#click-${p.key}`); if(cb) cb.checked=true; updateHistoryCellsForRow(p.key,tr); });
        projectCell.appendChild(a);

        if(p.referralNote || p.copyText){
          const span=document.createElement('span'); span.className='badge rounded-pill text-bg-secondary ms-2 note-badge code-badge';
          span.title=p.referralNote || 'Code'; span.textContent=p.referralNote || 'Code';
          span.addEventListener('click', async ()=>{ if(p.copyText){ try{ await navigator.clipboard.writeText(p.copyText); showToast(`Copied: ${p.copyText}`);}catch{ showToast('Copy failed'); } }});
          projectCell.appendChild(span);
        }
        tr.appendChild(projectCell);

        // Description
        const tdDesc=document.createElement('td'); tdDesc.className='desc-col'; tdDesc.textContent=p.desc || ''; tr.appendChild(tdDesc);

        // Routine
        const tdRoutine=document.createElement('td'); tdRoutine.className='routine-col'; tdRoutine.innerHTML=renderRoutine(p.routine); tr.appendChild(tdRoutine);

        // Routine Score (Pro)
        if (IS_SUBSCRIBER) {
          const tdScore = document.createElement('td'); tdScore.className='score-col';
          const s = completionStatsForProject(p.key);
          tdScore.innerHTML = `
            <div class="d-flex align-items-center gap-2">
              <div class="flex-grow-1">
                <div class="progress" style="height:10px;">
                  <div class="progress-bar bg-success" role="progressbar" style="width:${s.pct}%;" aria-valuenow="${s.pct}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="small text-secondary mt-1">${s.pct}% ‚Ä¢ ${s.completed}/${s.totalDays}d since ${s.since}</div>
              </div>
            </div>`;
          tr.appendChild(tdScore);
        }

        // Today: Click
        const tdClick=document.createElement('td'); tdClick.className='text-center';
        const cbClick=document.createElement('input'); cbClick.type='checkbox'; cbClick.className='form-check-input'; cbClick.id=`click-${p.key}`; cbClick.setAttribute('readonly','readonly');
        cbClick.checked=getDayState(p.key,today()).clicked; tdClick.appendChild(cbClick); tr.appendChild(tdClick);

        // Today: Farm
        const tdFarm=document.createElement('td'); tdFarm.className='text-center';
        const cbFarm=document.createElement('input'); cbFarm.type='checkbox'; cbFarm.className='form-check-input'; cbFarm.id=`farm-${p.key}`;
        cbFarm.checked=getDayState(p.key,today()).farmed;
        cbFarm.addEventListener('change',()=>{ setTodayState(p.key,{farmed:cbFarm.checked}); updateHistoryCellsForRow(p.key,tr); });
        tdFarm.appendChild(cbFarm); tr.appendChild(tdFarm);

        // Past windows
        days.forEach(d=>{const ds=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; tr.appendChild(makeStatusCell(stateToColor(getDayState(p.key,ds))));});
        weeks.forEach(w=>tr.appendChild(makeStatusCell(aggregateRange(p.key,w.start,w.end))));
        months.forEach(m=>tr.appendChild(makeStatusCell(aggregateRange(p.key,m.start,m.end))));
        quarters.forEach(q=>tr.appendChild(makeStatusCell(aggregateRange(p.key,q.start,q.end))));

        bodyEl.appendChild(tr);
      });
    }

    // ====== TOAST ======
    const showToast=(msg)=>{const tb=document.getElementById('toastBody'); tb.textContent=msg; const toast=new bootstrap.Toast(document.getElementById('toast')); toast.show();};

    // ====== BOUTONS ======
    document.getElementById('resetTodayBtn').addEventListener('click',()=>{const data=load(); const t=today(); PROJECTS.forEach(p=>{ if(data[p.key]?.daily?.[t]) data[p.key].daily[t]={clicked:false,farmed:false};}); save(data); PROJECTS.forEach(p=>{const c1=document.getElementById(`click-${p.key}`); const c2=document.getElementById(`farm-${p.key}`); if(c1) c1.checked=false; if(c2) c2.checked=false;}); renderBody(); showToast('Today reset.');});
    document.getElementById('resetAllBtn').addEventListener('click',()=>{ if(!confirm('This will erase ALL saved history for this tracker. Continue?')) return; localStorage.removeItem(STORAGE_KEY); renderBody(); showToast('All data cleared.');});
    document.getElementById('exportBtn').addEventListener('click',()=>{const blob=new Blob([localStorage.getItem(STORAGE_KEY)||'{}'],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`airdrop-tracker-${today()}.json`; a.click(); URL.revokeObjectURL(url);});
    document.getElementById('importInput').addEventListener('change',async(e)=>{const file=e.target.files?.[0]; if(!file) return; const text=await file.text(); try{ JSON.parse(text); localStorage.setItem(STORAGE_KEY,text); renderBody(); showToast('Import successful.'); }catch{ showToast('Invalid JSON file.'); }finally{ e.target.value=''; }});

    // ====== SUPABASE AUTH & CLOUD ======
    const sbModal = new bootstrap.Modal(document.getElementById('sbModal'));
    document.getElementById('sbAccountBtn').addEventListener('click', async ()=>{ await refreshSbAuthUI(); sbModal.show(); });

    async function upsertProfile(user){
      // cr√©e la ligne si absente, sans toucher √† is_subscriber / registered_at existants
      await sb.from('profiles').upsert({ user_id: user.id, email: user.email || null }, { onConflict: 'user_id' });
    }
    async function loadProfile(user){
      const { data: prof, error } = await sb.from('profiles').select('is_subscriber, registered_at, email').eq('user_id', user.id).single();
      if (error) { console.warn(error); return; }
      IS_SUBSCRIBER = !!prof.is_subscriber;
      REGISTERED_AT = prof.registered_at ? new Date(prof.registered_at) : new Date();
      const subBadge = document.getElementById('sbSubBadge');
      if (IS_SUBSCRIBER) { subBadge.className='badge text-bg-success'; subBadge.textContent='Pro subscriber'; }
      else { subBadge.className='badge text-bg-secondary'; subBadge.textContent='Free'; }
      renderHead(); renderBody();
    }
    async function refreshSbAuthUI(){
      const { data: { user } } = await sb.auth.getUser();
      const authArea = document.getElementById('sbAuthArea');
      const userArea = document.getElementById('sbUserArea');
      if (user) {
        IS_AUTH = true;
        authArea.classList.add('d-none');
        userArea.classList.remove('d-none');
        document.getElementById('sbUserEmail').textContent = user.email || '(no email)';
        await upsertProfile(user);
        await loadProfile(user);
      } else {
        IS_AUTH = false;
        authArea.classList.remove('d-none');
        userArea.classList.add('d-none');
        IS_SUBSCRIBER = false;
        REGISTERED_AT = null;
        renderHead(); renderBody();
      }
    }

    document.getElementById('sbSendLink').addEventListener('click', async ()=>{
      const email = document.getElementById('sbEmail').value.trim();
      if (!email) return showToast('Entrez un email.');
      const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
      showToast(error ? `Error: ${error.message}` : 'Magic link envoy√©. V√©rifiez votre bo√Æte mail.');
    });

    async function sbRequireUser(){
      const { data: { user } } = await sb.auth.getUser();
      if (!user) { showToast('Connectez-vous d‚Äôabord.'); throw new Error('no-user'); }
      return user;
    }

    document.getElementById('sbSave').addEventListener('click', async ()=>{
      try {
        const user = await sbRequireUser();
        const payload = load();
        const { error } = await sb.from('tracker_data').upsert({ user_id: user.id, data: payload }, { onConflict: 'user_id' });
        showToast(error ? `Save failed: ${error.message}` : 'Saved to cloud.');
        if (!error) document.getElementById('sbStatus').textContent = `Last save: ${new Date().toLocaleString()}`;
      } catch {}
    });

    document.getElementById('sbLoad').addEventListener('click', async ()=>{
      try {
        const user = await sbRequireUser();
        const { data, error } = await sb.from('tracker_data').select('data').eq('user_id', user.id).single();
        if (error && error.code !== 'PGRST116') { showToast(`Load failed: ${error.message}`); return; } // 116 = no rows
        const remote = data?.data || {};
        const merged = mergeData(load(), remote);
        save(merged);
        renderBody();
        showToast('Loaded & merged from cloud.');
        document.getElementById('sbStatus').textContent = `Last load: ${new Date().toLocaleString()}`;
      } catch {}
    });

    document.getElementById('sbSignOut').addEventListener('click', async ()=>{
      await sb.auth.signOut();
      await refreshSbAuthUI();
      showToast('Signed out.');
    });

    sb.auth.onAuthStateChange((_evt, _session)=>{ refreshSbAuthUI(); });

    // ====== MERGE ======
    function mergeData(a={}, b={}) {
      const out = JSON.parse(JSON.stringify(a || {}));
      for (const key of Object.keys(b || {})) {
        if (!out[key]) out[key] = { daily:{} };
        const bd = (b[key] && b[key].daily) || {};
        for (const d of Object.keys(bd)) {
          const r = bd[d] || {clicked:false,farmed:false};
          const l = (out[key].daily && out[key].daily[d]) || {clicked:false,farmed:false};
          out[key].daily[d] = { clicked: !!(l.clicked || r.clicked), farmed: !!(l.farmed || r.farmed) };
        }
      }
      return out;
    }

    // ====== INIT ======
    function init(){
      renderHead(); renderBody();
      refreshSbAuthUI();
    }
    init();
  </script>

  <!--
  ====== √Ä ex√©cuter UNE FOIS dans Supabase (SQL Editor) ======

  create table if not exists public.tracker_data (
    user_id uuid primary key references auth.users(id) on delete cascade,
    data jsonb not null default '{}'::jsonb,
    updated_at timestamptz not null default now()
  );
  alter table public.tracker_data enable row level security;
  create policy "own read" on public.tracker_data for select using (auth.uid() = user_id);
  create policy "own upsert" on public.tracker_data for insert with check (auth.uid() = user_id);
  create policy "own update" on public.tracker_data for update using (auth.uid() = user_id);

  create table if not exists public.profiles (
    user_id uuid primary key references auth.users(id) on delete cascade,
    email text,
    registered_at timestamptz not null default now(),
    is_subscriber boolean not null default false
  );
  alter table public.profiles enable row level security;
  create policy "own read" on public.profiles for select using (auth.uid() = user_id);
  create policy "own upsert" on public.profiles for insert with check (auth.uid() = user_id);
  create policy "own update" on public.profiles for update using (auth.uid() = user_id);

  -- Passer un utilisateur en "Pro" (admin):
  -- update public.profiles set is_subscriber = true where user_id = '...';
  -->
</body>
</html>
